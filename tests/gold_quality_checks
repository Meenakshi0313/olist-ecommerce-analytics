/*
==========================================================
Gold Layer Quality Checks
==========================================================
Purpose:
    This script performs data quality checks on the Gold layer
    tables/views in your data warehouse. It validates:
        - Row counts
        - NULLs in key columns
        - Duplicates
        - Referential integrity
        - Value sanity (numeric ranges, flags, etc.)
        - Date-related sanity using surrogate keys and day calculations

Tables/Views Covered:
    - gold.dim_customer
    - gold.dim_product
    - gold.dim_seller
    - gold.dim_date
    - gold.fact_order_items
==========================================================
*/

------------------------------------------------------------
-- dim_customer
------------------------------------------------------------

-- Row count
SELECT COUNT(*) AS dim_customer_row_count
FROM gold.dim_customer;

-- Check for NULLs in primary key
SELECT COUNT(*) AS null_customer_id
FROM gold.dim_customer
WHERE customer_id IS NULL;

-- Check for duplicates in primary key
SELECT customer_id, COUNT(*) AS cnt
FROM gold.dim_customer
GROUP BY customer_id
HAVING COUNT(*) > 1;

------------------------------------------------------------
--  dim_product
------------------------------------------------------------

-- Row count
SELECT COUNT(*) AS dim_product_row_count
FROM gold.dim_product;

-- Check for NULLs in primary key
SELECT COUNT(*) AS null_product_id
FROM gold.dim_product
WHERE product_id IS NULL;

-- Check for duplicates in primary key
SELECT product_id, COUNT(*) AS cnt
FROM gold.dim_product
GROUP BY product_id
HAVING COUNT(*) > 1;

-- Check numeric columns for negative values
SELECT *
FROM gold.dim_product
WHERE product_weight_g < 0
   OR product_length_cm < 0
   OR product_height_cm < 0
   OR product_width_cm < 0;

------------------------------------------------------------
--  dim_seller
------------------------------------------------------------

-- Row count
SELECT COUNT(*) AS dim_seller_row_count
FROM gold.dim_seller;

-- Check for NULLs in primary key
SELECT COUNT(*) AS null_seller_id
FROM gold.dim_seller
WHERE seller_id IS NULL;

-- Check for duplicates in primary key
SELECT seller_id, COUNT(*) AS cnt
FROM gold.dim_seller
GROUP BY seller_id
HAVING COUNT(*) > 1;

------------------------------------------------------------
--  dim_date
------------------------------------------------------------

-- Row count
SELECT COUNT(*) AS dim_date_row_count
FROM gold.dim_date;

-- Check for NULLs
SELECT COUNT(*) AS null_full_date
FROM gold.dim_date
WHERE full_date IS NULL;

-- Check for duplicates in date_key (if added)
SELECT date_key, COUNT(*) AS cnt
FROM gold.dim_date
GROUP BY date_key
HAVING COUNT(*) > 1;

------------------------------------------------------------
--  fact_order_items
------------------------------------------------------------

-- Row count
SELECT COUNT(*) AS fact_order_items_row_count
FROM gold.fact_order_items;

-- Check for NULLs in primary and foreign keys
SELECT COUNT(*) AS null_order_id
FROM gold.fact_order_items
WHERE order_id IS NULL;

SELECT COUNT(*) AS null_customer_id
FROM gold.fact_order_items
WHERE customer_id IS NULL;

SELECT COUNT(*) AS null_product_id
FROM gold.fact_order_items
WHERE product_id IS NULL;

SELECT COUNT(*) AS null_seller_id
FROM gold.fact_order_items
WHERE seller_id IS NULL;

-- Check duplicates on composite key (order_id, order_item_id)
SELECT order_id, order_item_id, COUNT(*) AS cnt
FROM gold.fact_order_items
GROUP BY order_id, order_item_id
HAVING COUNT(*) > 1;

-- Check numeric columns for invalid values
SELECT *
FROM gold.fact_order_items
WHERE price < 0
   OR freight_value < 0
   OR total_item_value < 0
   OR payment_value < 0
   OR approval_days < 0
   OR delivery_days < 0
   OR estimated_delivery_days < 0;

-- Check flags for 0/1 only
SELECT *
FROM gold.fact_order_items
WHERE carrier_before_approval_flag NOT IN (0,1)
   OR delivered_before_carrier_flag NOT IN (0,1);

------------------------------------------------------------
--  Referential Integrity Checks
------------------------------------------------------------

-- Customers exist in dimension
SELECT f.customer_id
FROM gold.fact_order_items f
LEFT JOIN gold.dim_customer c
    ON f.customer_id = c.customer_id
WHERE c.customer_id IS NULL;

-- Products exist in dimension
SELECT f.product_id
FROM gold.fact_order_items f
LEFT JOIN gold.dim_product p
    ON f.product_id = p.product_id
WHERE p.product_id IS NULL;

-- Sellers exist in dimension
SELECT f.seller_id
FROM gold.fact_order_items f
LEFT JOIN gold.dim_seller s
    ON f.seller_id = s.seller_id
WHERE s.seller_id IS NULL;

-- Date key exists in dimension (purchase_date_key)
SELECT f.purchase_date_key
FROM gold.fact_order_items f
LEFT JOIN gold.dim_date d
    ON f.purchase_date_key = d.date_key
WHERE d.date_key IS NULL;

------------------------------------------------------------
--  Date Sanity Checks using approval_days, delivery_days
------------------------------------------------------------

-- Approval before purchase (approval_days < 0)
SELECT *
FROM gold.fact_order_items
WHERE approval_days < 0;

-- Delivery before purchase (delivery_days < 0)
SELECT *
FROM gold.fact_order_items
WHERE delivery_days < 0;

-- Estimated delivery vs actual delivery
SELECT *
FROM gold.fact_order_items
WHERE estimated_delivery_days < 0;

------------------------------------------------------------
--  Status Checks
------------------------------------------------------------

-- Check for unknown order_status values
SELECT order_status, COUNT(*) AS cnt
FROM gold.fact_order_items
GROUP BY order_status
ORDER BY cnt DESC;

-- Check review score sanity (1-5)
SELECT *
FROM gold.fact_order_items
WHERE review_score IS NOT NULL
  AND (review_score < 1 OR review_score > 5);
