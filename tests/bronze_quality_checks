/*
============================================================
Layer: Bronze
Type: Data Quality Validation
Purpose: Validate raw ingested data before transformation
Environment: SQL Server
Author: <Your Name>
Date: <Date>

Description:
This script performs exploratory and quality checks on the
Bronze layer tables to identify:

- Null values
- Duplicate records
- Invalid data ranges
- Referential inconsistencies
- Unexpected values

These checks ensure data integrity before loading into Silver.
============================================================
*/

------------------------------------------------------------
-- CUSTOMERS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_customers FROM bronze.olist_customers_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_customers_dataset
WHERE customer_id IS NULL;

-- Duplicate Customers
SELECT customer_id, COUNT(*) AS duplicate_count
FROM bronze.olist_customers_dataset
GROUP BY customer_id
HAVING COUNT(*) > 1;



------------------------------------------------------------
-- GEOLOCATION TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_geolocations FROM bronze.olist_geolocation_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_geolocation_dataset
WHERE geolocation_zip_code_prefix IS NULL;

-- Duplicate Records
SELECT geolocation_zip_code_prefix,
       geolocation_lat,
       geolocation_lng,
       COUNT(*) AS duplicate_count
FROM bronze.olist_geolocation_dataset
GROUP BY geolocation_zip_code_prefix,
         geolocation_lat,
         geolocation_lng
HAVING COUNT(*) > 1;

-- Latitude / Longitude Range Validation
SELECT *
FROM bronze.olist_geolocation_dataset
WHERE geolocation_lat NOT BETWEEN -90 AND 90
   OR geolocation_lng NOT BETWEEN -180 AND 180;


------------------------------------------------------------
-- ORDER ITEMS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_order_items FROM bronze.olist_order_items_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_order_items_dataset
WHERE order_id IS NULL
   OR product_id IS NULL
   OR seller_id IS NULL;

-- Duplicate Composite Keys
SELECT order_id, order_item_id, COUNT(*) AS duplicate_count
FROM bronze.olist_order_items_dataset
GROUP BY order_id, order_item_id
HAVING COUNT(*) > 1;

-- Price Validation
SELECT *
FROM bronze.olist_order_items_dataset
WHERE price < 0 OR freight_value < 0;



------------------------------------------------------------
-- ORDER PAYMENTS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_payments FROM bronze.olist_order_payments_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_order_payments_dataset
WHERE order_id IS NULL;

-- Invalid Payment Values
SELECT *
FROM bronze.olist_order_payments_dataset
WHERE payment_value < 0;



------------------------------------------------------------
--ORDER  REVIEWS TABLE CHECKS (Loaded from Flat File)
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_reviews FROM bronze.olist_order_reviews_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_order_reviews_dataset
WHERE review_id IS NULL
   OR order_id IS NULL;

-- Duplicate Reviews
SELECT review_id, COUNT(*) AS duplicate_count
FROM bronze.olist_order_reviews_dataset
GROUP BY review_id
HAVING COUNT(*) > 1;

------------------------------------------------------------
-- ORDERS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_orders FROM bronze.olist_orders_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_orders_dataset
WHERE order_id IS NULL
   OR customer_id IS NULL;

-- Duplicate Order IDs
SELECT order_id, COUNT(*) AS duplicate_count
FROM bronze.olist_orders_dataset
GROUP BY order_id
HAVING COUNT(*) > 1;

-- Date Range Validation
SELECT MIN(order_purchase_timestamp) AS min_purchase_date,
       MAX(order_purchase_timestamp) AS max_purchase_date
FROM bronze.olist_orders_dataset;



------------------------------------------------------------
-- PRODUCTS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_products FROM bronze.olist_products_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_products_dataset
WHERE product_id IS NULL;

-- Duplicate Products
SELECT product_id, COUNT(*) AS duplicate_count
FROM bronze.olist_products_dataset
GROUP BY product_id
HAVING COUNT(*) > 1;



------------------------------------------------------------
-- SELLERS TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_sellers FROM bronze.olist_sellers_dataset;

-- Null Checks
SELECT *
FROM bronze.olist_sellers_dataset
WHERE seller_id IS NULL;

-- Duplicate Sellers
SELECT seller_id, COUNT(*) AS duplicate_count
FROM bronze.olist_sellers_dataset
GROUP BY seller_id
HAVING COUNT(*) > 1;



------------------------------------------------------------
-- PRODUCT CATEGORY NAME TRANSLATION TABLE CHECKS
------------------------------------------------------------

-- Row Count
SELECT COUNT(*) AS total_category_translations 
FROM bronze.product_category_name_translation;

-- Null Checks
SELECT *
FROM bronze.product_category_name_translation
WHERE product_category_name IS NULL
   OR product_category_name_english IS NULL;

-- Duplicate Categories
SELECT product_category_name,
       COUNT(*) AS duplicate_count
FROM bronze.product_category_name_translation
GROUP BY product_category_name
HAVING COUNT(*) > 1;

-- Products without Category Translation
SELECT p.*
FROM bronze.olist_products_dataset p
LEFT JOIN bronze.product_category_name_translation t
    ON p.product_category_name = t.product_category_name
WHERE t.product_category_name IS NULL;



------------------------------------------------------------
-- REFERENTIAL INTEGRITY CHECKS
------------------------------------------------------------

-- Orders without Customers
SELECT o.*
FROM bronze.olist_orders_dataset o
LEFT JOIN bronze.olist_customers_dataset c
    ON o.customer_id = c.customer_id
WHERE c.customer_id IS NULL;


-- Order Items without Orders
SELECT oi.*
FROM bronze.olist_order_items_dataset oi
LEFT JOIN bronze.olist_orders_dataset o
    ON oi.order_id = o.order_id
WHERE o.order_id IS NULL;


-- Order Items without Products
SELECT oi.*
FROM bronze.olist_order_items_dataset oi
LEFT JOIN bronze.olist_products_dataset p
    ON oi.product_id = p.product_id
WHERE p.product_id IS NULL;


-- Order Items without Sellers
SELECT oi.*
FROM bronze.olist_order_items_dataset oi
LEFT JOIN bronze.olist_sellers_dataset s
    ON oi.seller_id = s.seller_id
WHERE s.seller_id IS NULL;


------------------------------------------------------------
-- SUMMARY NOTE
------------------------------------------------------------
-- Review any returned records from the above queries.
-- Identified issues should be handled in Silver layer
-- transformations or flagged for data remediation.
------------------------------------------------------------
